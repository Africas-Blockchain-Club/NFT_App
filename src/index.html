<!DOCTYPE html>
<html>
<head>
  <title>Local AA NFT Minting</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.15.0/ethers.umd.min.js"></script>
</head>
<body>
  <h1>Local AA NFT Minting</h1>
  <button id="connectBtn">Connect Wallet</button>
  <button id="mintBtn" disabled>Mint Free NFT</button>
  <div id="networkStatus">Network: Not connected</div>
  <div id="status"></div>
  <div id="nfts"></div>

  <script>
    let provider, signer, nftContract;
    const LOCAL_RPC_URL = "http://127.0.0.1:8545";
    const LOCAL_CHAIN_ID = "0x7A69"; // 31337 in hex
    const contractAddress = "0x9b291177D53ADEbeBD56786a6CB1b24bbcC4847e";
    
    const nftAbi = [
      "function safeMint(address to) public",
      "function balanceOf(address owner) view returns (uint256)",
      "function ownerOf(uint256 tokenId) view returns (address)"
    ];

    document.getElementById('connectBtn').onclick = connectWallet;
    document.getElementById('mintBtn').onclick = mintNFT;

    // Check current network on page load and when network changes
    if (typeof window.ethereum !== 'undefined') {
      window.ethereum.on('chainChanged', handleChainChanged);
      checkCurrentNetwork();
    }

    function handleChainChanged(chainId) {
      console.log("Chain changed to:", chainId);
      checkCurrentNetwork();
    }

    async function checkCurrentNetwork() {
      if (typeof window.ethereum !== 'undefined') {
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        const isLocalNetwork = chainId === LOCAL_CHAIN_ID;
        
        document.getElementById('networkStatus').textContent = 
          `Network: ${isLocalNetwork ? 'Local Anvil ‚úÖ' : 'Wrong Network ‚ùå'}`;
        document.getElementById('networkStatus').style.color = 
          isLocalNetwork ? 'green' : 'red';
          
        return isLocalNetwork;
      }
      return false;
    }

    async function connectWallet() {
      if (typeof window.ethereum !== 'undefined') {
        try {
          // First, check if we're already on the right network
          const isCorrectNetwork = await checkCurrentNetwork();
          
          if (!isCorrectNetwork) {
            // Add local network if not already added
            try {
              await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [{
                  chainId: LOCAL_CHAIN_ID,
                  chainName: 'Local Anvil',
                  rpcUrls: [LOCAL_RPC_URL],
                  nativeCurrency: {
                    name: 'Ether',
                    symbol: 'ETH',
                    decimals: 18
                  }
                }]
              });
            } catch (addError) {
              console.log("Network may already be added:", addError);
            }
            
            // Switch to local network
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: LOCAL_CHAIN_ID }],
            });
            
            // Wait for network switch
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
          
          // Get accounts
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          
          // Re-check network after switching
          const isNowCorrectNetwork = await checkCurrentNetwork();
          
          if (!isNowCorrectNetwork) {
            throw new Error("Failed to switch to Local Anvil network");
          }
          
          provider = new ethers.BrowserProvider(window.ethereum);
          signer = await provider.getSigner();
          nftContract = new ethers.Contract(contractAddress, nftAbi, signer);
          
          document.getElementById('mintBtn').disabled = false;
          document.getElementById('status').textContent = "Connected to Local Network! ‚úÖ";
          document.getElementById('status').style.color = "green";
          
          await loadNFTs();
          
        } catch (error) {
          console.error("Connection error:", error);
          document.getElementById('status').textContent = "Error: " + error.message;
          document.getElementById('status').style.color = "red";
        }
      } else {
        document.getElementById('status').textContent = "Please install MetaMask!";
      }
    }

    async function mintNFT() {
      try {
        // DOUBLE-CHECK we're on the right network before minting
        const isCorrectNetwork = await checkCurrentNetwork();
        if (!isCorrectNetwork) {
          throw new Error("Please switch to Local Anvil network first");
        }
        
        const address = await signer.getAddress();
        document.getElementById('status').textContent = "Minting... ‚è≥";
        document.getElementById('status').style.color = "blue";
        
        const tx = await nftContract.safeMint(address);
        document.getElementById('status').textContent = "Transaction sent! Waiting...";
        
        await tx.wait();
        document.getElementById('status').textContent = "NFT Minted! ‚úÖ";
        document.getElementById('status').style.color = "green";
        
        await loadNFTs();
      } catch (error) {
        console.error(error);
        document.getElementById('status').textContent = "Error: " + error.message;
        document.getElementById('status').style.color = "red";
      }
    }

    async function loadNFTs() {
      try {
        const address = await signer.getAddress();
        const balance = await nftContract.balanceOf(address);
        
        let html = "<h2>Your NFTs:</h2>";
        if (balance > 0) {
          html += `<p>You own ${balance} NFT(s)! üéâ</p>`;
          for (let i = 0; i < balance; i++) {
            html += `<div>NFT #${i + 1}</div>`;
          }
        } else {
          html += "<p>No NFTs yet. Mint one above! üëÜ</p>";
        }
        document.getElementById('nfts').innerHTML = html;
      } catch (error) {
        console.error("Error loading NFTs:", error);
        document.getElementById('nfts').innerHTML = "<p>Error loading NFTs</p>";
      }
    }
  </script>
</body>
</html>