<!DOCTYPE html>
<html>
<head>
  <title>Local AA NFT Minting</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.15.0/ethers.umd.min.js"></script>
</head>
<body>
  <h1>Local AA NFT Minting</h1>
  <button id="connectBtn">Connect Wallet</button>
  <button id="mintBtn" disabled>Mint Free NFT</button>
  <div id="networkStatus">Network: Not connected</div>
  <div id="status"></div>
  <div id="nfts"></div>
  <script src="https://unpkg.com/userop@latest/dist/userop.js"></script>
    <script src="https://unpkg.com/@account-abstraction/utils@latest/dist/index.js"></script>
  <script>
    let provider, signer, nftContract;
    const LOCAL_RPC_URL = "http://127.0.0.1:8545";
    const LOCAL_CHAIN_ID = "0x7a69"; // 31337 in hex
    const contractAddress = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
    
    const nftAbi = [
        "function safeMint(address to) public",
        "function balanceOf(address owner) view returns (uint256)",
        "function ownerOf(uint256 tokenId) view returns (address)"
    ];

    document.getElementById('connectBtn').onclick = connectWallet;
    document.getElementById('mintBtn').onclick = mintNFT;

    // Listen for network changes
    if (typeof window.ethereum !== 'undefined') {
        window.ethereum.on('chainChanged', (chainId) => {
            console.log('Network changed to:', chainId);
            checkNetworkAndUpdateUI();
        });
    }

    async function connectWallet() {
        if (typeof window.ethereum !== 'undefined') {
            try {
                document.getElementById('status').textContent = "Connecting...";
                document.getElementById('status').style.color = "blue";
                
                // Request account connection
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Check current network
                const isOnCorrectNetwork = await checkNetworkAndUpdateUI();
                
                if (!isOnCorrectNetwork) {
                    await ensureLocalNetwork();
                }
                
                // Initialize ethers
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                nftContract = new ethers.Contract(contractAddress, nftAbi, signer);
                
                document.getElementById('mintBtn').disabled = false;
                document.getElementById('status').textContent = "Connected! Ready to mint! ‚úÖ";
                document.getElementById('status').style.color = "green";
                
                await loadNFTs();
                
            } catch (error) {
                console.error("Connection error:", error);
                document.getElementById('status').textContent = "Error: " + error.message;
                document.getElementById('status').style.color = "red";
            }
        } else {
            document.getElementById('status').textContent = "Please install MetaMask!";
        }
    }

    async function checkNetworkAndUpdateUI() {
        try {
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            const isLocalNetwork = (chainId === LOCAL_CHAIN_ID);
            
            document.getElementById('networkStatus').textContent = 
                `Network: ${isLocalNetwork ? 'Local Anvil ‚úÖ' : 'Wrong Network ‚ùå'}`;
            document.getElementById('networkStatus').style.color = 
                isLocalNetwork ? 'green' : 'red';
            
            console.log('Current network chainId:', chainId, 'Expected:', LOCAL_CHAIN_ID, 'Match:', isLocalNetwork);
            
            return isLocalNetwork;
        } catch (error) {
            console.error('Network check error:', error);
            return false;
        }
    }

    async function ensureLocalNetwork() {
        try {
            // Try to switch to local network
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: LOCAL_CHAIN_ID }],
            });
        } catch (switchError) {
            // If network doesn't exist, add it
            if (switchError.code === 4902) {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: LOCAL_CHAIN_ID,
                        chainName: 'Local Anvil',
                        rpcUrls: [LOCAL_RPC_URL],
                        nativeCurrency: {
                            name: 'Ether',
                            symbol: 'ETH',
                            decimals: 18
                        }
                    }]
                });
            } else {
                throw new Error("Could not switch to Local Anvil network");
            }
        }
    }

    async function mintNFT() {
    try {
        // Use case-insensitive comparison here too
        const isCorrectNetwork = await checkNetworkAndUpdateUI();
        console.log('Network check before mint:', isCorrectNetwork);
        
        if (!isCorrectNetwork) {
            const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
            // Show the actual comparison issue
            throw new Error(`Network case mismatch! Current: ${currentChainId} vs Expected: ${LOCAL_CHAIN_ID}. Please refresh.`);
        }
        
        // Rest of your minting code...
    } catch (error) {
        console.error('Mint error:', error);
        document.getElementById('status').textContent = "Error: " + error.message;
        document.getElementById('status').style.color = "red";
    }
}

    async function loadNFTs() {
        try {
            const address = await signer.getAddress();
            const balance = await nftContract.balanceOf(address);
            
            let html = "<h2>Your NFTs:</h2>";
            if (balance > 0) {
                html += `<p>You own ${balance} NFT(s)! üéâ</p>`;
                for (let i = 0; i < balance; i++) {
                    html += `<div>NFT #${i + 1}</div>`;
                }
            } else {
                html += "<p>No NFTs yet. Mint one above! üëÜ</p>";
            }
            document.getElementById('nfts').innerHTML = html;
        } catch (error) {
            console.error("Error loading NFTs:", error);
            document.getElementById('nfts').innerHTML = "<p>Error loading NFTs</p>";
        }
    }

    // Initial check on page load
    if (typeof window.ethereum !== 'undefined') {
        checkNetworkAndUpdateUI();
    }
</script>
<script>
// AA Implementation using ethers.js
class SimpleAA {
    constructor(provider, entryPointAddress, factoryAddress) {
        this.provider = provider;
        this.entryPointAddress = entryPointAddress;
        this.factoryAddress = factoryAddress;
    }
    
    async createSmartAccount() {
        // Create a simple smart account
        const factory = new ethers.Contract(this.factoryAddress, [
            "function createAccount(address owner, uint256 salt) returns (address)"
        ], this.provider);
        
        // Use a random salt for account creation
        const salt = Date.now();
        const ownerAddress = await this.provider.getSigner().getAddress();
        
        // Predict the smart account address
        const predictedAddress = await factory.createAccount.staticCall(ownerAddress, salt);
        
        return {
            address: predictedAddress,
            factory: factory,
            salt: salt,
            owner: ownerAddress
        };
    }
    
    async createUserOp(target, data, value = 0) {
        // Simple UserOperation creation
        return {
            sender: this.smartAccount.address,
            nonce: await this.getNonce(),
            initCode: this.getInitCode(),
            callData: this.encodeCallData(target, data, value),
            callGasLimit: 1000000,
            verificationGasLimit: 1000000,
            preVerificationGas: 100000,
            maxFeePerGas: await this.getGasPrice(),
            maxPriorityFeePerGas: await this.getPriorityFee(),
            paymasterAndData: "0x",
            signature: "0x"
        };
    }
    
    // ... additional helper methods
}

// Initialize AA
let aaClient;

async function initAA() {
    const provider = new ethers.BrowserProvider(window.ethereum);
    const signer = await provider.getSigner();
    
    // For local development, use these test addresses
    aaClient = new SimpleAA(
        provider,
        "0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789", // EntryPoint
        "0x9406Cc6185a346906296840746125a0E44976454"  // Factory
    );
    
    return aaClient;
}
</script>
  <div style="margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
    <p><strong>Troubleshooting:</strong> If automatic network switch fails:</p>
    <button onclick="manualSwitchHelp()" style="background: #ff9900; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
      Show Manual Setup Instructions
    </button>
  </div>
</body>
</html>